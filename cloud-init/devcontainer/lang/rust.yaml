#cloud-config

write_files:
  - path: /usr/local/bin/rust-install-loader.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      
      # Usage: $0 [master|feature_rust_2.0.0|...]
      # Downloads and runs Rust install.sh from specified ref (default: master)
      
      REF="${1:-master}"
      if [ "${REF}" != "master" ]; then
          REF="refs/tags/${REF}"
      else
          REF="refs/heads/${REF}"
      fi
      
      # GitHub repository details
      REPO_OWNER="zyrakq"
      REPO_NAME="arch-devcontainer-features"
      SCRIPT_PATH="src/rust/install.sh"
      
      # Construct download URL
      RUST_INSTALLER_URL="https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${REF}/${SCRIPT_PATH}"
      INSTALL_SCRIPT="/tmp/install-rust-$$.sh"
      
      echo "=== Rust Installation Loader ==="
      echo "Repository: ${REPO_OWNER}/${REPO_NAME}"
      echo "Reference: ${REF}"
      echo "Downloading from: ${RUST_INSTALLER_URL}"
      echo ""
      
      # Download installer script
      if ! curl -fsSL -o "${INSTALL_SCRIPT}" "${RUST_INSTALLER_URL}"; then
        echo "ERROR: Failed to download Rust installer" >&2
        exit 1
      fi
      
      # Verify downloaded file is not empty
      if [ ! -s "${INSTALL_SCRIPT}" ]; then
        echo "ERROR: Downloaded file is empty" >&2
        rm -f "${INSTALL_SCRIPT}"
        exit 1
      fi
      
      # Make script executable
      chmod +x "${INSTALL_SCRIPT}"
      
      echo "Running Rust installer..."
      echo "Configuration:"
      echo "  INSTALLRUSTSRC=${INSTALLRUSTSRC:-not set}"
      echo "  INSTALLRUSTANALYZER=${INSTALLRUSTANALYZER:-not set}"
      echo "  GLOBALCRATES=${GLOBALCRATES:-not set}"
      echo "  USERNAME=${USERNAME:-not set}"
      echo ""
      
      # Execute installer script
      "${INSTALL_SCRIPT}"
      
      # Cleanup
      rm -f "${INSTALL_SCRIPT}"
      
      echo ""
      echo "âœ“ Rust installation completed successfully!"

runcmd:
  - export USERNAME=${USERNAME:-archuser}
  - |
    INSTALLRUSTSRC=${RUST_INSTALL_RUST_SRC:-"true"}
    INSTALLRUSTANALYZER=${RUST_INSTALL_RUST_ANALYZER:-"true"}
    GLOBALCRATES=${RUST_GLOBAL_CRATES:-""} \
    USERNAME=${USERNAME} \
    /usr/local/bin/rust-install-loader.sh ${RUST_REF:-master}