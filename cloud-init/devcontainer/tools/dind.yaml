#cloud-config
write_files:
  - path: /usr/local/bin/docker-install-loader.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -e
      # Usage: $0 [main|v1.25.1|...]
      # Downloads and runs Docker-in-Docker install.sh from specified ref (default: main)
      
      REF="${1:-main}"
      if [ "${REF}" != "main" ]; then
          REF="refs/tags/${REF}"
      fi
      
      INSTALL_SH_URL="https://raw.githubusercontent.com/bartventer/arch-devcontainer-features/${REF}/src/docker-in-docker/install.sh"
      TEMP_INSTALL_SH="/tmp/install-docker.sh"
      
      echo "Downloading Docker install script from ${INSTALL_SH_URL}..."
      curl -fsSL "${INSTALL_SH_URL}" -o "${TEMP_INSTALL_SH}"
      
      echo "Making install script executable..."
      chmod +x "${TEMP_INSTALL_SH}"
      
      echo "Running install script..."
      "${TEMP_INSTALL_SH}" "$@"
      
      echo "Cleaning up temporary install script..."
      rm -f "${TEMP_INSTALL_SH}"
      
      echo "Docker-in-Docker installation complete!"

runcmd:
  - |
    VERSION=latest \
    DOCKERDASHCOMPOSEVERSION=latest \
    AZUREDNSAUTODETECTION=true \
    DOCKERDEFAULTADDRESSPOOL="" \
    INSTALLDOCKERBUILDX=true \
    INSTALLDOCKERCOMPOSESWITCH=true \
    USERNAME=archuser \
    /usr/local/bin/docker-install-loader.sh main
  - systemctl enable --now docker.service
  - timeout 30 bash -c 'until docker info &>/dev/null; do sleep 1; done'
  - echo "Docker is ready!"